rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    function isAuthenticated() {
      return request.auth != null;
    }

    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isDeveloper() {
      return hasRole('developer');
    }

    function isManager() {
      return hasRole('manager');
    }

    function isStaffRole() {
      return isAdmin() || isDeveloper() || isManager();
    }

    function canUpload() {
      return isStaffRole();
    }

    function canReplaceOrDelete() {
      return isAdmin() || isDeveloper();
    }

    function isCreate() {
      return resource == null && request.resource != null;
    }

    function isReplace() {
      return resource != null && request.resource != null;
    }

    function isDelete() {
      return resource != null && request.resource == null;
    }

    function isAllowedImageType() {
      return request.resource.contentType in [
        'image/jpeg',
        'image/png',
        'image/webp',
        'image/gif',
        'image/avif',
        'image/bmp',
        'image/tiff',
        'image/heic',
        'image/heif'
      ];
    }

    function isAllowedDocumentType() {
      return request.resource.contentType in [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/rtf',
        'application/vnd.oasis.opendocument.text',
        'text/plain'
      ];
    }

    function isValidImageUpload() {
      return request.resource != null &&
        request.resource.size <= 5 * 1024 * 1024 &&
        isAllowedImageType();
    }

    function isValidDocumentUpload() {
      return request.resource != null &&
        request.resource.size <= 20 * 1024 * 1024 &&
        isAllowedDocumentType();
    }

    /*
     * Portfolio and vacancy images:
     * - public read
     * - all team roles can create
     * - only admin/developer can replace or delete
     */
    match /uploads/portfolio/{projectId}/{fileName} {
      allow read: if true;
      allow write: if (
          isCreate() && canUpload() && isValidImageUpload()
        ) || (
          (isReplace() || isDelete()) && canReplaceOrDelete() &&
          (isDelete() || isValidImageUpload())
        );
    }

    match /uploads/vacancies/{vacancyId}/{fileName} {
      allow read: if true;
      allow write: if (
          isCreate() && canUpload() && isValidImageUpload()
        ) || (
          (isReplace() || isDelete()) && canReplaceOrDelete() &&
          (isDelete() || isValidImageUpload())
        );
    }

    /*
     * Candidate CV and project-order attachments:
     * - private read (staff only)
     * - all team roles can create
     * - only admin/developer can replace or delete
     */
    match /uploads/submissions/{submissionId}/{fileName} {
      allow read: if isStaffRole();
      allow write: if (
          isCreate() && canUpload() && isValidDocumentUpload()
        ) || (
          (isReplace() || isDelete()) && canReplaceOrDelete() &&
          (isDelete() || isValidDocumentUpload())
        );
    }

    /*
     * Security baseline: deny all unspecified Storage paths.
     */
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
